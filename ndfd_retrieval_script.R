# script to get current ndfd data

# load libraries
library(tidyverse)
library(ndfd)

# ndfd pacakge page
# https://github.com/BigelowLab/ndfd

# install first time
# library(devtools)
# install_github("BigelowLab/ndfd")

# querey ndfd locations along nc coast
nc_coast_bbox <- c(-80, -75, 33, 37)
nc_ndfd_loc_query <- ndfd::list_this(what = "points_in_subgrid",  
                            listLon1 = nc_coast_bbox[1], 
                            listLon2 = nc_coast_bbox[2], 
                            listLat1 = nc_coast_bbox[3], 
                            listLat2 = nc_coast_bbox[4])
nc_ndfd_loc_query_obj <- ndfd::NDFD(nc_ndfd_loc_query)

# top right 36.629031, -75.184528
# bottom right 33.744582, -75.184528
# top left 36.629031, -79.349893
# bottom left 33.744582, -79.349893

# get data frame of locations
# nc_ndfd_loc <- my_ndfd_points_obj$latLonList$get_location() # makes dataframe
nc_ndfd_loc <- my_ndfd_points_obj$latLonList$get_location(form = "as_is") # makes character string

# query data at locations
my_element <- "temp" # 'qpf' # liquid precip amount
# see element codes here: https://graphical.weather.gov/xml/docs/elementInputNames.php
nc_ndfd_data_query <- ndfd::query_this(what = "subgrid",
                                       lon1 = nc_coast_bbox[1], 
                                       lon2 = nc_coast_bbox[2], 
                                       lat1 = nc_coast_bbox[3],
                                       lat2 = nc_coast_bbox[4],
                                       product = "time-series",
                                       element = my_element,
                                       begin = "2019-01-14T12:00",
                                       end = "2019-01-15T12:00",
                                       resolutionSub = 75)
nc_ndfd_data_query_obj <- ndfd::NDFD(nc_ndfd_data_query)



# ---- test vignette code ----
# list sites in bbox
my_query <- list_this(what = "points_in_subgrid",
                      listLon1 = -72,
                      listLon2 = -63,
                      listLat1 = 39,
                      listLat2 = 46)
"whichClient=NDFDgenSubgrid&lon1=-72.00000&lon2=-63.00000&lat1=39.00000&lat2=46.00000&product=time-series&begin=2016-05-14T12:00&end=2016-05-17T12:00&resolutionSub=75.00000&Unit=m&temp=temp"
X <- NDFD(my_query)
X
# getting results but they have no head like in the vignette
xy <- X$latLonList$get_location()
str(xy)
# looks ok, getting more observations than the vignette
loc <- X$latLonList$get_location(form = 'as_is')
my_query <- query_this(what = "multipoint", 
                       listLonLat = loc, 
                       element = 'temp', 
                       begin ='2016-05-14T12:00', 
                       end = '2016-05-16T12:00')
X2 <- NDFD(my_query)
# getting error (same as vignette)
my_query <- query_this(what = "subgrid",  
                       lon1 = -72, 
                       lon2 = -63, 
                       lat1 = 39, 
                       lat2 = 46, 
                       product = 'time-series', 
                       element = 'temp',
                       begin = '2016-05-14T12:00', 
                       end = '2016-05-17T12:00', 
                       resolutionSub = 75)
X3 <- NDFD(my_query)
# i'm getting an error from the sample code so something must be 
# happening on ndfd's end
# error message 500 = internal server error


"whichClient=LatLonListSubgrid&lon1=-72.00000&lon2=-63.00000&lat1=39.00000&lat2=46.00000&product=time-series&begin=2016-05-14T12:00&end=2016-05-17T12:00&resolutionSub=75.00000&Unit=m&temp=temp"

# other info on the ndfd server
# https://graphical.weather.gov/xml/#generate_it


x <- c(878.7302, 883.80963, 888.88904, 893.96844, 899.04785, 904.12726, 909.20667, 914.2861, 919.3655, 924.4449, 929.5243, 934.6037, 939.6831, 944.7625, 949.8419, 954.9213, 960.00073, 965.08014, 970.15955, 975.23895, 980.31836, 985.39777, 990.4772, 995.5566, 1000.636, 1005.7154, 1010.7948, 1015.8742, 1020.9536, 1026.033, 1031.1124, 1036.1918, 1041.2712, 1046.3506, 1051.43, 1056.5094, 1061.5889, 1066.6682, 1071.7477, 1076.827, 1081.9065, 1086.9858, 1092.0653, 1097.1447, 1102.2241, 1107.3035, 1112.3829, 1117.4623, 1122.5417, 1127.6211, 1132.7006, 1137.7799, 1142.8594, 1147.9387, 1153.0182, 1158.0975, 1163.177, 1168.2563, 1173.3358, 1178.4152, 1183.4946, 1188.574, 1193.6533, 1198.7328, 1203.8121, 1208.8916, 1213.971, 1219.0504, 1224.1298, 1229.2092, 1234.2886, 1239.368, 1244.4474, 1249.5269, 1254.6062, 1259.6857, 1264.765, 1269.8445, 1274.9238, 1280.0033, 1285.0826, 1290.1621, 1295.2415, 1300.3209, 1305.4003, 1310.4797, 1315.5591, 1320.6385, 1325.7179, 1330.7974, 1335.8767, 1340.9562, 1346.0355, 1351.115, 1356.1943, 1361.2738, 1366.3531, 1371.4326, 1376.512, 1381.5914, 1386.6708, 1391.7502, 1396.8296, 1401.909, 1406.9884, 1412.0679, 1417.1472, 1422.2267, 1427.306, 1432.3855, 1437.4648, 1442.5443, 1447.6237, 1452.7031, 1457.7825, 1462.8619, 1467.9413, 1473.0208, 1478.1001, 1483.1796, 1488.2589, 1493.3384, 1498.4177, 1503.4972, 1508.5765, 1513.656, 1518.7354, 1523.8147, 1528.8942, 1533.9735, 1539.053, 1544.1323, 1549.2118, 1554.2911, 1559.3706, 1564.45, 1569.5294, 1574.6088, 1579.6882, 1584.7676, 1589.847, 1594.9264, 1600.0059, 1605.0852, 1610.1647, 1615.244, 1620.3235, 1625.4028, 1630.4823, 1635.5616, 1640.6411, 1645.7205, 1650.7999, 1655.8793, 1660.9587, 1666.0381, 1671.1176, 1676.1969, 1681.2764, 1686.3557, 1691.4352, 1696.5145, 1701.594, 1706.6733, 1711.7528, 1716.8322, 1721.9116, 1726.991, 1732.0704, 1737.1498, 1742.2292, 1747.3086, 1752.3881, 1757.4674, 1762.5469, 1767.6262, 1772.7057, 1777.785, 1782.8645, 1787.9438, 1793.0233, 1798.1027, 1803.1821, 1808.2615, 1813.341, 1818.4203, 1823.4998, 1828.5791, 1833.6586, 1838.7379, 1843.8173, 1848.8967, 1853.9761, 1859.0555)
y <- c(741.9331, 747.0125, 752.0919, 757.1713, 762.25073, 767.33014, 772.40955, 777.48895, 782.56836, 787.64777, 792.7272, 797.8066, 802.886, 807.96533, 813.04474, 818.12415, 823.20355, 828.28296, 833.36237, 838.4418, 843.5212, 848.6006, 853.68, 858.7594, 863.8388, 868.9182, 873.9976, 879.077, 884.15643, 889.23584, 894.31525, 899.39465, 904.47406, 909.55347, 914.6329, 919.7123, 924.7917, 929.8711, 934.9505, 940.0299, 945.1093, 950.1887, 955.2681, 960.34753, 965.42694, 970.50635, 975.58575, 980.66516, 985.74457, 990.824, 995.9034, 1000.9828, 1006.0622, 1011.1416, 1016.221, 1021.3004, 1026.3798, 1031.4592, 1036.5386, 1041.618, 1046.6974, 1051.7769, 1056.8562, 1061.9357, 1067.015, 1072.0945, 1077.1738, 1082.2533, 1087.3326, 1092.4121, 1097.4915, 1102.5709, 1107.6503, 1112.7297, 1117.8091, 1122.8885, 1127.9679, 1133.0474, 1138.1267, 1143.2062, 1148.2855, 1153.365, 1158.4443, 1163.5238, 1168.6031, 1173.6826, 1178.762, 1183.8414, 1188.9208, 1194.0002, 1199.0796, 1204.159, 1209.2384, 1214.3179, 1219.3972, 1224.4767, 1229.556, 1234.6355, 1239.7148, 1244.7943, 1249.8737, 1254.9531, 1260.0325, 1265.1119, 1270.1913, 1275.2708, 1280.3501, 1285.4296, 1290.5089, 1295.5883, 1300.6677, 1305.7471, 1310.8265, 1315.9059, 1320.9854, 1326.0647, 1331.1442, 1336.2235, 1341.303, 1346.3823, 1351.4618, 1356.5411, 1361.6206, 1366.7, 1371.7794, 1376.8588, 1381.9382, 1387.0176, 1392.097, 1397.1764, 1402.2559, 1407.3352, 1412.4147, 1417.494, 1422.5735, 1427.6528, 1432.7323, 1437.8116, 1442.8911, 1447.9705, 1453.0499, 1458.1293, 1463.2087, 1468.2881, 1473.3676, 1478.4469, 1483.5264, 1488.6057, 1493.6852, 1498.7645, 1503.844, 1508.9233, 1514.0028, 1519.0822, 1524.1616, 1529.241, 1534.3204, 1539.3998, 1544.4792, 1549.5586, 1554.6381, 1559.7174, 1564.7969, 1569.8762, 1574.9557, 1580.035, 1585.1145, 1590.1938, 1595.2733, 1600.3527, 1605.4321, 1610.5115, 1615.591, 1620.6703, 1625.7496, 1630.8291, 1635.9084, 1640.9879, 1646.0673, 1651.1467, 1656.2261, 1661.3055, 1666.3849, 1671.4644, 1676.5437, 1681.6232, 1686.7025, 1691.782, 1696.8613, 1701.9408, 1707.0201, 1712.0996, 1717.179, 1722.2584, 1727.3378, 1732.4172, 1737.4966, 1742.576, 1747.6554, 1752.7349)


